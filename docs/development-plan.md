# 璇脑 (xuan-brain) 开发计划

## 📋 当前状态 (v0.1.0 - 已完成)

### ✅ 已实现功能
- 基础文献管理（DOI/arXiv ID 导入）
- 分类树管理（树形结构、拖拽）
- 标签系统（自定义颜色）
- 三栏布局（可调整宽度）
- 主题切换（暗色/亮色）
- 国际化支持（中英文）
- 本地数据存储（SeaORM + SQLite）

## 🎯 v0.2.0 开发计划

### 阶段 1: 文件导入功能增强（预计 2-3 周）

#### 1.1 本地文件导入
**优先级**: ⭐⭐⭐⭐（高）

**任务清单**:
- [ ] 创建文件选择对话框组件
  - 使用 Tauri 的 `dialog` 插件打开文件选择器
  - 支持多文件选择
  - 过滤支持的文件类型（.pdf, .docx, .epub）
  
- [ ] 实现文件解析器模块
  ```
  src-tauri/src/parser/
  ├── mod.rs           # 解析器入口
  ├── pdf.rs           # PDF 解析（使用 pdfium）
  ├── docx.rs          # DOCX 解析
  └── epub.rs          # EPUB 解析
  ```
  
- [ ] 后端命令实现
  ```rust
  // src-tauri/src/command/paper_command.rs
  #[tauri::command]
  pub async fn import_paper_from_file(file_path: PathBuf) -> Result<PaperDto>
  
  #[tauri::command]
  pub async fn import_papers_from_files(file_paths: Vec<PathBuf>) -> Result<Vec<PaperDto>>
  ```
  
- [ ] 前端导入 UI
  - 在工具栏添加"导入文件"按钮
  - 添加拖拽上传功能
  - 显示导入进度

**技术要点**:
- 使用 `tauri-plugin-fs` 读取文件
- 使用 `tauri-plugin-dialog` 打开文件选择器
- PDF 解析：`pdfium` 或 `lopdf`
- DOCX 解析：`docx-rs` 或 `quick-xml`
- 异步处理大文件，避免阻塞 UI

**验收标准**:
- ✅ 能够导入单个 PDF 文件
- ✅ 能够批量导入多个文件
- ✅ 正确提取元数据（标题、作者）
- ✅ 导入过程中显示进度
- ✅ 错误处理友好提示

---

#### 1.2 元数据提取增强
**优先级**: ⭐⭐⭐⭐（高）

**任务清单**:
- [ ] PDF 元数据提取优化
  - 从 PDF 属性提取标题、作者
  - 提取摘要（如果有）
  - 提取出版信息（如果有）
  
- [ ] DOCX 元数据提取
  - 解析 `docProps/app.xml` 获取元数据
  - 提取文档内容
  
- [ ] 智能元数据补全
  - 使用标题搜索 DOI
  - 如果找到 DOI，自动补全其他元数据
  
- [ ] 文件存储管理
  - 设计文件存储目录结构
  - 避免重复存储
  - 支持文件移动和删除

**技术要点**:
- PDF 使用 `pdfium` 的元数据 API
- DOCX 使用 `quick-xml` 解析 XML
- DOI 搜索：使用 Crossref API
- 文件存储：`<data_dir>/attachments/<paper_id>/`

**验收标准**:
- ✅ PDF 元数据提取准确率 > 80%
- ✅ DOCX 元数据提取准确率 > 90%
- ✅ 自动补全功能成功匹配常用期刊
- ✅ 文件存储不占用过多空间

---

### 阶段 2: PDF 阅读器（预计 3-4 周）

#### 2.1 PDF 阅读器基础功能
**优先级**: ⭐⭐⭐⭐（高）

**任务清单**:
- [ ] PDF 渲染器选择
  - 评估选项：`pdf.js` vs `pdfium-wasm` vs `pdfjs-dist`
  - 推荐使用 `pdfjs-dist`（React 生态成熟）
  
- [ ] 阅读器 UI 组件
  ```
  src/components/reader/
  ├── PDFViewer.tsx      # 主阅读器组件
  ├── PDFToolbar.tsx     # 工具栏（缩放、翻页）
  ├── PDFSidebar.tsx      # 侧边栏（目录、缩略图）
  └── PDFFullscreen.tsx  # 全屏模式
  ```
  
- [ ] 核心阅读功能
  - 单页/双页模式
  - 缩放（25% - 400%）
  - 翻页（快捷键、鼠标滚轮、按钮）
  - 页面跳转（页码、百分比）
  
- [ ] 目录导航
  - 解析 PDF 目录
  - 点击目录跳转到对应页面
  - 高亮当前章节

**技术要点**:
- 使用 `react-pdf` 或 `pdfjs-dist`
- 状态管理：当前页码、缩放比例、滚动位置
- 使用 `React.memo` 优化渲染性能
- 使用 `IntersectionObserver` 实现懒加载

**验收标准**:
- ✅ 流畅渲染 100 页以上的 PDF
- ✅ 缩放和翻页无明显延迟
- ✅ 支持常见快捷键（Page Up/Down, Space, 箭头）
- ✅ 目录导航准确

---

#### 2.2 标注和高亮功能
**优先级**: ⭐⭐⭐（中）

**任务清单**:
- [ ] 文本选择和复制
  - 支持文本选择
  - 复制到剪贴板
  
- [ ] 高亮标注
  - 文本高亮（多种颜色）
  - 区域高亮
  - 矩形标注
  
- [ ] 笔记功能
  - 添加笔记到页面
  - 快速笔记（选中文本后）
  - 笔记列表视图
  
- [ ] 标注数据结构
  ```rust
  // src-tauri/src/database/entities/annotations.rs
  #[derive(Clone, Debug, PartialEq, DeriveEntityModel)]
  #[sea_orm(table_name = "annotations")]
  pub struct Model {
      #[sea_orm(primary_key)]
      pub id: i64,
      pub paper_id: i64,
      pub page_number: i32,
      pub annotation_type: String, // "highlight", "note", "area"
      pub content: Option<String>,  // 文本内容
      pub note: Option<String>,     // 笔记内容
      pub color: Option<String>,    // 高亮颜色
      pub position: String,        // JSON 格式的位置信息
      pub created_at: DateTime,
  }
  ```

**技术要点**:
- 使用 `pdf.js` 的 `getTextContent` API
- 存储标注位置（坐标、页码）
- 使用 Canvas 叠加层显示标注
- Zustand 存储临时标注状态

**验收标准**:
- ✅ 文本选择准确
- ✅ 高亮显示美观
- ✅ 笔记保存和加载正常
- ✅ 标注位置在缩放时正确

---

### 阶段 3: 搜索和检索（预计 2 周）

#### 3.1 全文搜索
**优先级**: ⭐⭐⭐⭐（高）

**任务清单**:
- [ ] 搜索 UI 组件
  ```
  src/components/search/
  ├── SearchBar.tsx       # 搜索输入框
  ├── SearchFilters.tsx   # 筛选器
  └── SearchResults.tsx   # 搜索结果
  ```
  
- [ ] 基础搜索功能
  - 标题搜索
  - 作者搜索
  - 摘要搜索
  - 标签搜索
  
- [ ] 高级搜索
  - 多字段组合查询
  - 时间范围筛选
  - 分类筛选
  - 标签筛选
  
- [ ] 搜索结果高亮
  - 高亮匹配关键词
  - 显示匹配上下文
  
- [ ] 搜索历史
  - 保存最近搜索
  - 快速重新搜索

**技术要点**:
- 使用 SeaORM 的 `QueryFilter` 构建查询
- 使用 `LIKE` 和 `MATCH` 进行文本匹配
- 考虑使用 FTS5 (Full-Text Search) 扩展
- 防抖搜索输入（300ms）

**验收标准**:
- ✅ 搜索响应时间 < 500ms（< 1000 条文献）
- ✅ 支持多关键词组合
- ✅ 搜索结果按相关性排序
- ✅ 高亮显示匹配内容

---

#### 3.2 搜索优化
**优先级**: ⭐⭐（中）

**任务清单**:
- [ ] 全文索引
  - 使用 SQLite FTS5 扩展
  - 建立全文索引表
  - 定期更新索引
  
- [ ] 搜索性能优化
  - 添加搜索结果缓存
  - 实现虚拟滚动（大量结果）
  - 分页加载
  
- [ ] 搜索建议
  - 实时搜索建议
  - 拼写纠正
  - 同义词扩展

**技术要点**:
- FTS5 配置：`CREATE VIRTUAL TABLE papers_fts USING fts5(...)`
- 使用 `bm25` 排序算法
- 实现搜索结果分页（20 条/页）

**验收标准**:
- ✅ 全文搜索 < 100ms
- ✅ 支持 10,000+ 文献库
- ✅ 搜索建议准确

---

### 阶段 4: 管理功能完善（预计 2 周）

#### 4.1 作者管理
**优先级**: ⭐⭐⭐（中）

**任务清单**:
- [ ] 作者列表页面
  - 显示所有作者
  - 按文献数量排序
  - 按字母分组
  
- [ ] 作者详情页面
  - 显示作者所有文献
  - 显示作者统计信息
  - 支持作者合并
  
- [ ] 作者编辑
  - 添加作者别名
  - 修正作者姓名格式
  - 合并重复作者

**技术要点**:
- 使用 SeaORM 的 `find_also_related`
- 实现作者合并的事务操作
- 使用 Ant Design 的 `List` 组件

**验收标准**:
- ✅ 作者列表加载快速
- ✅ 作者详情准确
- ✅ 合并操作可逆

---

#### 4.2 关键词管理
**优先级**: ⭐⭐（中）

**任务清单**:
- [ ] 关键词列表
  - 显示所有关键词
  - 按使用频率排序
  - 词云可视化
  
- [ ] 关键词编辑
  - 手动添加关键词
  - 编辑关键词名称
  - 删除无用关键词
  
- [ ] 关键词关联
  - 批量添加关键词到文献
  - 智能推荐关键词
  - 导入/导出关键词

**技术要点**:
- 关键词存储：`paper_keywords` 关联表
- 词云使用 `d3-cloud` 或 `wordcloud2.js`
- 实现关键词批量操作

**验收标准**:
- ✅ 关键词统计准确
- ✅ 词云渲染美观
- ✅ 批量操作高效

---

#### 4.3 附件管理
**优先级**: ⭐⭐（中）

**任务清单**:
- [ ] 附件列表
  - 显示文献附件
  - 显示附件类型和大小
  - 支持预览
  
- [ ] 附件操作
  - 上传附件
  - 下载附件
  - 删除附件
  
- [ ] 附件存储
  - 文件去重
  - 压缩存储（可选）
  - 备份策略

**技术要点**:
- 使用 `tauri-plugin-fs` 管理文件
- 附件存储：`<data_dir>/attachments/<paper_id>/`
- 实现文件去重（SHA256）

**验收标准**:
- ✅ 上传速度 > 10MB/s
- ✅ 文件不丢失
- ✅ 存储空间使用合理

---

#### 4.4 设置页面
**优先级**: ⭐⭐⭐（中）

**任务清单**:
- [ ] 设置页面结构
  ```
  src/pages/SettingsPage.tsx
  ├── AppearanceTab.tsx    # 外观设置
  ├── DataTab.tsx          # 数据管理
  ├── ImportTab.tsx        # 导入设置
  └── AboutTab.tsx         # 关于页面
  ```
  
- [ ] 外观设置
  - 主题选择（亮色/暗色/系统）
  - 强调色选择
  - 字体大小设置
  
- [ ] 数据管理
  - 数据库路径查看
  - 数据备份/恢复
  - 数据导出（JSON/CSV）
  - 数据清理（删除空分类、无效标签）
  
- [ ] 导入设置
  - 默认 DOI 解析器选择
  - 元数据自动补全开关
  
- [ ] 关于页面
  - 版本信息
  - 许可证
  - 致谢列表
  - 反馈渠道

**技术要点**:
- 使用 Ant Design 的 `Tabs` 组件
- 设置持久化到 localStorage
- 数据备份使用 `tauri-plugin-dialog`

**验收标准**:
- ✅ 所有设置即时生效
- ✅ 设置正确保存和加载
- ✅ 数据备份可靠
- ✅ 界面友好

---

## 🚀 v0.3.0 开发计划（未来版本）

### 阶段 5: AI 功能（预计 4-5 周）

#### 5.1 智能推荐
**优先级**: ⭐⭐（中）

**任务清单**:
- [ ] 相似论文推荐
  - 基于标题相似度
  - 基于摘要相似度
  - 基于共同引用
  
- [ ] 推荐算法
  ```
  src-tauri/src/ai/
  ├── recommend.rs       # 推荐引擎
  ├── embeddings.rs      # 文本嵌入
  └── similarity.rs     # 相似度计算
  ```
  
- [ ] 推荐界面
  - 相关论文列表
  - 推荐原因说明
  - 优化推荐算法

**技术要点**:
- 使用 `rust-bert` 或 `tch-rs` 加载模型
- 文本嵌入：Sentence-BERT
- 相似度：余弦相似度
- 缓存推荐结果

**验收标准**:
- ✅ 推荐相关性 > 70%
- ✅ 推荐速度 < 2s
- ✅ 支持离线推荐

---

#### 5.2 自动分类
**优先级**: ⭐⭐（中）

**任务清单**:
- [ ] 分类模型训练
  - 使用现有分类数据
  - 训练文本分类模型
  
- [ ] 自动分类功能
  - 新文献自动分类
  - 显示分类置信度
  - 支持手动调整
  
- [ ] 分类建议
  - 提示可能的分类
  - 支持确认/拒绝

**技术要点**:
- 使用 `linfa` 机器学习框架
- 文本特征：TF-IDF
- 模型：朴素贝叶斯 / SVM

**验收标准**:
- ✅ 分类准确率 > 80%
- ✅ 分类速度 < 1s

---

### 阶段 6: 高级功能（预计 3-4 周）

#### 6.1 引用格式生成
**优先级**: ⭐⭐（中）

**任务清单**:
- [ ] 引用格式支持
  - APA
  - MLA
  - Chicago
  - IEEE
  - GB/T 7714
  
- [ ] 引用生成器
  ```
  src-tauri/src/citation/
  ├── mod.rs            # 引用模块
  ├── formatter.rs       # 格式化器
  └── templates.rs      # 模板管理
  ```
  
- [ ] 引用导出
  - 单篇引用复制
  - 批量导出（BibTeX、EndNote）
  - Word 插入（RTF）

**技术要点**:
- 使用 `csl` (Citation Style Language)
- 模板引擎：`tera` 或 `askama`
- 支持 `bib` 文件导入/导出

**验收标准**:
- ✅ 支持至少 5 种格式
- ✅ 格式符合标准
- ✅ 支持批量导出

---

#### 6.2 笔记和标注增强
**优先级**: ⭐⭐（中）

**任务清单**:
- [ ] 富文本笔记
  - Markdown 支持
  - 代码高亮
  - 图片插入
  
- [ ] 笔记管理
  - 笔记列表
  - 笔记搜索
  - 笔记导出（Markdown）
  
- [ ] 标注导出
  - 导出为 PDF
  - 导出为 Anki 卡片
  - 导出为 Obsidian 笔记

**技术要点**:
- Markdown 编辑器：`react-markdown-editor-lite`
- 代码高亮：`react-syntax-highlighter`
- 导出使用 `jsPDF`

**验收标准**:
- ✅ Markdown 渲染正确
- ✅ 导出功能完整
- ✅ 笔记搜索准确

---

### 阶段 7: 同步和扩展（预计 4-5 周）

#### 7.1 云同步
**优先级**: ⭐（低）

**任务清单**:
- [ ] 同步架构设计
  ```
  src-tauri/src/sync/
  ├── mod.rs            # 同步模块
  ├── cloud.rs          # 云端同步
  ├── encrypt.rs        # 加密模块
  └── conflict.rs      # 冲突解决
  ```
  
- [ ] 端到端加密
  - 使用 AES-256-GCM
  - 密钥管理（用户密码）
  - 安全存储密钥
  
- [ ] 增量同步
  - 检测文件变更
  - 上传/下载增量
  - 断点续传
  
- [ ] 冲突解决
  - 时间戳比较
  - 自动合并策略
  - 手动解决界面

**技术要点**:
- 加密：`rust-crypto` 或 `aes-gcm`
- 文件同步：`tauri-plugin-upload`
- WebSocket 用于实时同步

**验收标准**:
- ✅ 同步可靠（无数据丢失）
- ✅ 加密安全
- ✅ 冲突解决合理

---

#### 7.2 WebDAV 支持
**优先级**: ⭐（低）

**任务清单**:
- [ ] WebDAV 客户端
  - 连接配置
  - 文件列表
  - 上传/下载
  
- [ ] WebDAV 同步
  - 使用 WebDAV 协议
  - 支持常用服务（坚果云、OwnCloud）
  
- [ ] 配置管理
  - 保存 WebDAV 配置
  - 测试连接
  - 错误处理

**技术要点**:
- 使用 `webdav-handler` 或 `davcli`
- HTTP 客户端：`reqwest`

**验收标准**:
- ✅ 支持主流 WebDAV 服务
- ✅ 同步稳定

---

#### 7.3 插件系统
**优先级**: ⭐（低）

**任务清单**:
- [ ] 插件架构
  ```
  src-tauri/src/plugins/
  ├── mod.rs            # 插件管理器
  ├── rust_plugin.rs    # Rust 插件加载器
  ├── js_plugin.rs      # JS 插件引擎
  └── api.rs           # 插件 API
  ```
  
- [ ] Rust 插件支持
  - 动态库加载
  - API 定义
  - 沙箱隔离
  
- [ ] JavaScript 插件支持
  - QuickJS/V8 引擎
  - UI 注入
  - 事件系统
  
- [ ] 插件市场
  - 插件列表
  - 安装/卸载
  - 权限管理

**技术要点**:
- Rust 插件：`libloading`
- JS 插件：`rquickjs`
- 权限：声明式权限系统

**验收标准**:
- ✅ 插件加载安全
- ✅ API 易用
- ✅ 沙箱有效

---

#### 7.4 RESTful API
**优先级**: ⭐（低）

**任务清单**:
- [ ] API 服务器
  ```
  src-tauri/src/api/
  ├── mod.rs            # API 入口
  ├── routes.rs        # 路由定义
  ├── auth.rs          # 认证
  └── middleware.rs    # 中间件
  ```
  
- [ ] RESTful 端点
  - 文献 CRUD
  - 分类 CRUD
  - 搜索 API
  
- [ ] 认证和授权
  - JWT Token
  - API Key
  - CORS 支持
  
- [ ] API 文档
  - OpenAPI/Swagger
  - 示例代码

**技术要点**:
- Web 框架：`actix-web` 或 `axum`
- 认证：`jsonwebtoken`
- 文档：`utoipa`

**验收标准**:
- ✅ API 响应快速
- ✅ 文档完整
- ✅ 安全可靠

---

## 📅 总体时间线

| 版本 | 阶段 | 预计时间 | 关键里程碑 |
|------|--------|----------|-----------|
| v0.1.0 | 基础功能 | ✅ 已完成 | 基础框架搭建 |
| v0.2.0 | 阶段 1 | 2-3 周 | 本地文件导入 |
| v0.2.0 | 阶段 2 | 3-4 周 | PDF 阅读器 |
| v0.2.0 | 阶段 3 | 2 周 | 全文搜索 |
| v0.2.0 | 阶段 4 | 2 周 | 设置页面 |
| v0.2.0 | **总计** | **9-11 周** | **v0.2.0 发布** |
| v0.3.0 | 阶段 5 | 4-5 周 | AI 功能 |
| v0.3.0 | 阶段 6 | 3-4 周 | 引用生成 |
| v0.3.0 | 阶段 7 | 4-5 周 | 云同步 |
| v0.3.0 | **总计** | **11-14 周** | **v0.3.0 发布** |

## 🎯 开发优先级

### 高优先级（立即开始）
1. **本地文件导入** - 核心功能，用户最需要
2. **PDF 阅读器** - 核心功能，用户体验关键
3. **全文搜索** - 核心功能，效率提升
4. **设置页面** - 基础功能，用户配置需求

### 中优先级（v0.2.0 后期）
5. 作者管理 - 增强功能
6. 关键词管理 - 增强功能
7. 附件管理 - 增强功能

### 低优先级（v0.3.0）
8. AI 功能 - 高级功能，需要大量研发
9. 云同步 - 高级功能，需要架构设计
10. 插件系统 - 高级功能，长期规划

## 🛠️ 技术准备

### 必须安装的依赖

**Rust 依赖**（在 v0.2.0 阶段）:
```toml
# Cargo.toml 新增依赖
pdfium = "0.1"              # PDF 解析
docx-rs = "0.4"             # DOCX 解析
epub = "0.1"                 # EPUB 解析
rust-crypto = "0.2"          # 加密（v0.3.0）
actix-web = "4.0"             # API 框架（v0.3.0）
linfa = "0.7"                 # 机器学习（v0.3.0）
tch-rs = "0.12"              # PyTorch 绑定（v0.3.0）
```

**前端依赖**（在 v0.2.0 阶段）:
```json
{
  "dependencies": {
    "react-pdf": "^7.7.0",        // PDF 渲染
    "react-markdown-editor-lite": "^1.3.0",  // Markdown 编辑器（v0.3.0）
    "d3-cloud": "^1.2.5",       // 词云（v0.3.0）
    "wordcloud2.js": "^1.2.0"    // 词云备选（v0.3.0）
  }
}
```

### 开发工具设置
```bash
# 安装代码质量工具
cargo install cargo-audit      # 依赖安全扫描
cargo install cargo-outdated   # 依赖更新检查

# 安装前端工具
yarn add -D @types/react-pdf   # 类型定义
```

## 📊 里程碑和发布计划

### v0.2.0 里程碑
**目标**: 完善核心文献管理功能

**发布条件**:
- ✅ 所有阶段 1-4 功能完成
- ✅ 单元测试覆盖率 > 70%
- ✅ 集成测试通过
- ✅ 文档更新（用户手册）
- ✅ 性能测试通过（10000 文献库）

**预计发布时间**: 开发开始后 9-11 周

### v0.3.0 里程碑
**目标**: 实现高级功能和扩展性

**发布条件**:
- ✅ 所有阶段 5-7 功能完成
- ✅ 单元测试覆盖率 > 80%
- ✅ 端到端测试完成
- ✅ 完整文档（API 文档、插件开发指南）
- ✅ 安全审计通过

**预计发布时间**: v0.2.0 发布后 11-14 周

## 🔍 风险和缓解策略

### 技术风险
1. **PDF 解析复杂性**
   - 风险: 不同 PDF 格式兼容性问题
   - 缓解: 使用成熟的 PDF 库，充分测试
   
2. **AI 功能性能**
   - 风险: 模型推理速度慢
   - 缓解: 使用轻量级模型，缓存结果

3. **云同步稳定性**
   - 风险: 网络问题导致数据不一致
   - 缓解: 实现增量同步、冲突解决

### 进度风险
1. **功能范围蔓延**
   - 风险: 添加非计划功能
   - 缓解: 严格遵循路线图，定期评审

2. **技术债务积累**
   - 风险: 快速开发导致代码质量下降
   - 缓解: 持续重构、代码审查

## 📝 下一步行动

### 本周任务（第 1 周）
1. ✅ 完成 PDF 阅读器技术选型
2. ⬜ 创建文件导入对话框组件
3. ⬜ 实现基础的文件选择功能
4. ⬜ 搭建解析器模块结构

### 下周任务（第 2 周）
1. ⬜ 实现 PDF 解析器基础功能
2. ⬜ 实现 DOCX 解析器基础功能
3. ⬜ 创建导入进度显示组件
4. ⬜ 编写导入功能单元测试

### 第 3-4 周任务
1. ⬜ 完成 PDF 渲染器集成
2. ⬜ 实现阅读器基础 UI
3. ⬜ 实现缩放和翻页功能
4. ⬜ 添加目录导航功能

---

**最后更新**: 2025-01-28
**预计完成 v0.2.0**: 2025-04（约 2-3 个月后）
**预计完成 v0.3.0**: 2025-07（约 5-6 个月后）